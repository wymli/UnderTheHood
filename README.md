
# UnderTheHood
学习笔记

# 目录

# 正文
## 数据库概述
1. 关系型行存数据库rdb比如mysql、sqllite，物理存储上以一行为单位存储。oltp的典型代表，侧重事务（有关系才有事务）。一般来说，行存应用的场景是点查，即给定一个id查到对应的元素，其实和kv数据库差不多，但是元素一般是多列（或者说多field）的。
2. 键值数据库比如redis、rocksdb，etcd等，物理存储上就是一个key一个value。kv数据库有一些典型的使用方式：如果将一个元素的多个field先序列化成string，再存到kv里，完成primaryKey->serialized_value的映射，那kv也能存多列数据，实际场景这种方式也用的不少，局限是只能使用主键查询，不能用其他列做筛选。另一种方式是借助kv物理存储上按key的有序性，这样同样一行记录的不同列由于有了相同的key前缀，能够被一起查出来，相当于行存了，类似 key_${key_name}_field_${field_name} : ${field_value}。实际上，kv数据库是经常被用作其他更high level数据库（比如rdb，比如列存db）的存储引擎的。
4. 列存数据库比如hbase、clickhouse，物理存储上按列存储，olap的典型代表，侧重分析或者说计算。典型的是给定一些记录，要快速计算一些指标，比如点击率（总点击数除以总曝光数），比如要衡量单条样本在总体样本里的受欢迎程度（该样本总点击数除以总点击数），比如某个人对某样本的喜欢程度相比于总体对该样本的喜欢程度（（某人对样本的点击数/某人的总点击数）/（该样本总点击数/总点击数））等
5. 图数据库比如dgraph，建模为点和边，点有多个属性，边类似于mysql的外键关联其他点。图数据库可以用kv或者关系型数据库等作为存储引擎，或者是原生的图存储（评价原生与否与“无需索引的邻接关系遍历”的技术有关，即邻边存的不是主键索引而是物理地址）。
6. 向量数据库，存储的记录的字段主要是向量，也可以是标量，用户可以在向量字段上创建向量索引，也可以在标量字段上创建标量索引，然后查询时同时使用对应的索引查出来记录。
7. 时序数据库如opentsdb、Prometheus，一般存的是metrics、log之类的强时序的内容，技术上有比如delta of delta之类的时间戳压缩方式节约存储空间。

## milvus
> 1. 代码：https://github.com/milvus-io/milvus
> 2. 官网：https://milvus.io/
>

一款向量数据库。作为数据库，db、table的概念都有。db只是一个namespace的概念，实际上无论任何存储或者计算，都有namespace的概念。一个存储集群通过namespace在同一个存储集群完成不同存储空间的隔离，计算集群也类似，通过计算队列完成隔离，不同队列就是不同的namespace。在一般的设计上，namespace不是一个用户必须要创建的概念，会默认创建一个'default' namespace。table在这里叫collections。在向量数据库中，一行记录有多个字段，一个字段的类型可以是标量，也可以是向量。记录必须有主键。用户可以在表上创建标量索引和向量索引。常见的使用方式是：给定一个user_embedding=[0,0,1,10,12], 以及查询条件item_category=体育, 查询在体育分类下的与user_embedding相近的item，最终查询结果是item的主键item_id，这展示了向量索引和标量索引的同时使用。 

使用向量数据库，只是存储，还需要和计算向量的步骤搭配。比如item_embedding如何得到？user_embedding如何得到？无论是用户或者物品，都有多个特征，这多个特征如何过图得到embedding? 比如用户的特征是用户性别=1, 用户最近看过电影=[1000,23999,12323], 这里的每个特征称之为特征field，特征field可能包含多个特征原始值，在训练时，特征原始值会先被hash为fid。首先为每个fid随机初始化一个embedding向量，随后将特征field进行pooling（这称为图外计算），最终每个特征field得到一个embedding，然后过图。这里的图以fm为例，fm=lr+特征交叉，即y=Σ<wi, xi> + Σ<vi, vj><xi, xj>。这里的vi代表每个特征值xi（注意是特征值，不是特征域；即每个fid要对应一个隐向量）的隐向量。

## 特征
推荐领域中，特征主要是三类：用户、物品、ctx。其中ctx指的是请求的上下文特征，是不需要离线计算的，只需要在线抽取就行，比如用户手机型号、请求时间、手机imei等。用户类特征常需要实时计算更新，比如用户性别、用户最近点击item列表、用户短时喜欢一级类目、用户长时喜欢一级类目等；item类特征一般比较固定，比如item一级类目，item发布时间等。一条样本是这三大类特征的concat（称之为预估样本）再加上label。
针对这三大类特征，需要选择并抽取具体的特征。有一些特别的分类：  
1. 交叉特征：特征在图外可以先手动交叉，比如用户最近是否点击过此item，这是用户侧特征：用户最近点击物品列表和物品侧特征物品id的交叉。手动交叉特征来提高这类交叉特征的重要性。另一种交叉方式是简单的拼接，比如直接字符串拼接用户城市年龄性别来成为一个新的特征，这是认为同一个城市年龄性别的人会有类似的喜好。
2. list类特征：列表类，比如最近点击列表。
3. match类特征：一种交叉特征，特征取值为0/1，即某个特征和某个特征是否匹配上，比如用户是否最近点击过此item。
4. 
